#!/bin/bash

# TODO Usage

FACT=$1
VALUE=$2
CMD="facter ${FACT}"
PAR=3

source $(dirname $0)/../conf/doll.cfg

usage() {
	echo " doll factfilter <fact> <value to filter>"
	echo
	echo " filter for dolls where given <fact>'s value"
	echo " equals given value"
	exit 1
}

[ $# -ne 2 ] && usage

TMPDIR=$(mktemp -d)

[ -s "$(dirname $0)/../conf/${DOLLFILE}" ] && {
	parallel-ssh \
		--hosts="$(dirname $0)/../conf/${DOLLFILE}" \
		-l ${REMOTEUSER} \
		-p ${PAR} \
		-O ConnectTimeout=${CONNECTION_TIMEOUT} \
		-t ${CMD_TIMEOUT} \
		-o ${TMPDIR} \
		-P ${CMD}
	
	doll clear
	
	for HOST in $(ls ${TMPDIR})
	do
		ACTUAL=$(cat ${TMPDIR}/${HOST})
		[ "${ACTUAL}" == "${VALUE}" ] && echo ${HOST} >> "$(dirname $0)/../conf/${DOLLFILE}"
	done
}

